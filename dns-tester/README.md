# DNS Tester in K8s cluster

Utility to test reliability of communications between the DNS of a Kubernetes cluster and pods running in each of the worker nodes.

## Pre-requirements

- K8s cluster available with sufficient permissions.
- `kubectl` client.
- `helm` client (option).

**NOTE:** For basic testing, a _kind_ cluster may suffice:

```bash
kind create cluster --name cluster-dns-test --config=kind/multi-node-LARGE.yaml
```

## Usage

First, deploy a `daemonset`, where each pod sends continuous queries to the cluster's DNS:

```bash
kubectl apply -f manifests/

# Verify correct deployment
kubectl get pod -n dns-tester | grep dns-tester
```

Once deployed, logs generated by the tester pods can be retrieved based on the corresponding label:

```bash
kubectl -n dns-tester logs -l app.kubernetes.io/name=dns-tester -f
```

It is also advisable retrieving the correspondence between pod names and worker node names, for better interpretation:

```bash
kubectl get pod -l app.kubernetes.io/name=dns-tester -o=custom-columns=NAME:.metadata.name,STATUS:.status.phase,NODE:.spec.nodeName --all-namespaces
```

## Cleanup

Deletes `daemonset`:

```bash
kubectl delete -f manifests/
```

If applicable, deletes the _kind_ cluster:

```bash
kind delete cluster --name cluster-dns-test
```

## Advanced topics

### Configuration

The behaviour of the tester pod can be adapted by using environment variables:

- `DESTINATION`: Domain name to be resolved by DNS (defaults to _google.com_).

### Development: How to build, test and push the Docker image

Image build and push:

```bash
# Login
#export CR_PAT=GITHUB_TOKEN
#echo $CR_PAT | docker login ghcr.io -u fjramons --password-stdin

# Build
export REPO=docker.io/fjramons
export TAG=0.1
docker build -t $REPO/dns-tester:$TAG .
docker image ls | grep dns-tester

# Push
docker push $REPO/dns-tester:$TAG

# Docker run test 1 (default: query about 'google.com' every 2 seconds)
docker run -it --rm --name mitester $REPO/dns-tester:$TAG

# Docker run test 2
export DEST=disney.com  # other query
export INTERV=0.5       # 2 queries per second
docker run -it --rm --name mitester --env DESTINATION=$DEST --env INTERVAL=$INTERV $REPO/dns-tester:$TAG
```

**NOTE:** If using a _kind_ cluster, the local image needs to be transferred to the nodes manually:

```bash
kind load docker-image $REPO/dns-tester:$TAG -n cluster-dns-test
```
